{% extends "layouts/admin_base.html" %}
{% block page_title %}Client Software Access{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<div class="container mt-4">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-primary text-white">
            <h3 class="m-0">Manage Client App Access</h3>
        </div>
        <div class="card-body">
            <div class="user-info mb-3">
                <p><strong>Name:</strong> {{ user.fullname }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>Role:</strong> {{ user.role }}</p>
            </div>
            <hr>
            <div class="mb-3">
                <input type="text" id="appSearch" class="form-control" placeholder="Search apps...">
            </div>
            <div class="app-list" id="appList">
                {% if apps %}
                    {% for app in apps %}
                    <div class="app-item d-flex justify-content-between align-items-center"
                         data-app="{{ app.name }}" data-user-id="{{ user.id }}">
                        <div class="app-name">{{ app.name }}</div>
                        <div class="app-actions">
                            {% if app.id in permitted_ids %}
                                <span class="badge bg-success me-2">Allowed</span>
                                <button class="btn btn-danger btn-sm"
                                    onclick="updateAppAccess(event, '{{ user.id }}','{{ app.id }}','remove')">
                                    Remove
                                </button>
                            {% else %}
                                <span class="badge bg-secondary me-2">Not Allowed</span>
                                <button class="btn btn-success btn-sm"
                                    onclick="updateAppAccess(event, '{{ user.id }}','{{ app.id }}','add')">
                                    Allow
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info text-center">
                        <p class="mb-0">No software available. Please upload software from the Client Apps page.</p>
                    </div>
                {% endif %}
            </div>
            <a href="{{ url_for('admin_user_profile', user_id=user.id) }}"
               class="btn btn-secondary mt-4">Back to Profile</a>
        </div>
    </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">
<script src="{{ url_for('static', filename='script/csrf_helper.js') }}"></script>

<script>
document.getElementById("appSearch").addEventListener("input", function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll(".app-item").forEach(item => {
        const app = item.getAttribute("data-app").toLowerCase();
        item.style.display = app.includes(query) ? "flex" : "none";
    });
});

function updateAppAccess(evt, userId, appId, action) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const button = evt.target;
    const appItem = button.closest('.app-item');

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    const formData = new URLSearchParams();
    formData.append('client_id', userId);
    formData.append('app_id', appId);

    fetch('/admin/client-apps/' + (action === 'add' ? 'grant' : 'revoke'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRF-Token': csrfToken
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "granted" || data.status === "revoked") {
            updateAppAccessUI(appItem, userId, appId, action === "add");
            showNotification("Access " + (action === "add" ? "granted" : "revoked") + " successfully", "success");
        } else {
            showNotification("Error updating access", "error");
        }
    })
    .catch(() => showNotification("Error updating access", "error"))
    .finally(() => {
        button.disabled = false;
    });
}

function updateAppAccessUI(appItem, userId, appId, isAllowed) {
    const actions = appItem.querySelector(".app-actions");
    if (isAllowed) {
        actions.innerHTML = `
            <span class="badge bg-success me-2">Allowed</span>
            <button class="btn btn-danger btn-sm"
                onclick="updateAppAccess(event,'${userId}','${appId}','remove')">
                Remove
            </button>`;
    } else {
        actions.innerHTML = `
            <span class="badge bg-secondary me-2">Not Allowed</span>
            <button class="btn btn-success btn-sm"
                onclick="updateAppAccess(event,'${userId}','${appId}','add')">
                Allow
            </button>`;
    }
}

function showNotification(message, type) {
    const div = document.createElement("div");
    div.className = `alert alert-${type === "success" ? "success" : "danger"} position-fixed`;
    div.style.cssText = "top:20px;right:20px;z-index:9999;";
    div.textContent = message;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}
</script>

<style>
.app-item {
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
}
.app-item:last-child {
    border-bottom: none;
}
.app-name {
    font-weight: 500;
}
</style>

{% endblock %}
