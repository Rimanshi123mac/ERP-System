{% extends "layouts/admin_base.html" %}

{% block page_title %}Admin Profile{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='admin_profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}

<!-- WRAPPER 1 -->
<div class="client-profile-page">

    <div class="profile-header">
      <div class="avatar-circle">
        {{ admin_fullname[0]|upper if admin_fullname else 'A' }}
      </div>
      <div>
        <h2 class="profile-name">{{ admin_fullname or 'Admin' }}</h2>
        <p class="profile-subtitle">Administrator Profile</p>
      </div>
    </div>

    <div class="profile-tabs">
      <button class="tab active" data-tab="general">General</button>
      <button class="tab" data-tab="appearance">Appearance</button>
      <button class="tab" data-tab="password">Change Password</button>
    </div>

  <!-- WRAPPER 2 -->
  <div class="profile-card">
    
    <!-- GENERAL TAB -->
    <div class="tab-content active" id="general">
      <form onsubmit="saveAdminProfile(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="adminFullname" value="{{ admin_fullname or '' }}" disabled>
        </div>

        <div class="form-group">
          <label>Username</label>
          <input type="text" id="adminUsername" value="{{ admin_username or '' }}" disabled>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="adminEmail" value="{{ admin_email or '' }}" disabled>
        </div>
      </form>
    </div>

    <!-- APPEARANCE TAB -->
    <div class="tab-content" id="appearance">
      <div class="appearance-preview">
        <h3 class="section-title">Theme</h3>
        <div class="theme-options">
          <div class="theme light{% if user_prefs and user_prefs.theme == 'light' or not user_prefs %} selected{% endif %}" data-theme="light"></div>
          <div class="theme dark{% if user_prefs and user_prefs.theme == 'dark' %} selected{% endif %}" data-theme="dark"></div>
          <div class="theme aqua{% if user_prefs and user_prefs.theme == 'aqua' %} selected{% endif %}" data-theme="aqua"></div>
          <div class="theme green{% if user_prefs and user_prefs.theme == 'green' %} selected{% endif %}" data-theme="green"></div>
        </div>

        <h3 class="section-title mt-24">Font Style</h3>

        <div class="form-group-inline">
          <select id="fontFamily">
            <option value="Poppins"{% if user_prefs and user_prefs.font_family == 'Poppins' or not user_prefs %} selected{% endif %}>Poppins</option>
            <option value="Arial"{% if user_prefs and user_prefs.font_family == 'Arial' %} selected{% endif %}>Arial</option>
            <option value="Inter"{% if user_prefs and user_prefs.font_family == 'Inter' %} selected{% endif %}>Inter</option>
          </select>

          <select id="fontSize">
            <option value="14px"{% if user_prefs and user_prefs.font_size == '14px' %} selected{% endif %}>14px</option>
            <option value="16px"{% if user_prefs and user_prefs.font_size == '16px' or not user_prefs %} selected{% endif %}>16px</option>
            <option value="18px"{% if user_prefs and user_prefs.font_size == '18px' %} selected{% endif %}>18px</option>
          </select>

          <div class="bold-toggle">
            <label class="switch">
              <input type="checkbox" id="boldToggle"{% if user_prefs and user_prefs.is_bold %} checked{% endif %}>
              <span class="slider"></span>
            </label>
            <span class="bold-label">Bold</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSWORD TAB -->
    <div class="tab-content" id="password">
      <form onsubmit="changePassword(event); return false;">
        <div class="form-group">
          <label>Current Password</label>
          <div class="password-wrapper">
            <input type="password" id="current_password">
            <span class="toggle-password" onclick="togglePassword('current_password', this)">Show</span>
          </div>
        </div>

        <div class="form-group">
          <label>New Password</label>
          <div class="password-wrapper">
            <input type="password" id="new_password">
            <span class="toggle-password" onclick="togglePassword('new_password', this)">Show</span>
          </div>
        </div>

        <div class="form-group">
          <label>Confirm Password</label>
          <div class="password-wrapper">
            <input type="password" id="confirm_password">
            <span class="toggle-password" onclick="togglePassword('confirm_password', this)">Show</span>
          </div> 
        </div>

        <button type="submit" class="btn-primary">Update Password</button>
      </form>
    </div>

  </div>
</div>
<!-- 
<script>
// Tab switching
const tabs = document.querySelectorAll(".tab");
const contents = document.querySelectorAll(".tab-content");

tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    contents.forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Theme selector
const wrapper = document.querySelector(".main-wrapper");
if (wrapper) {
  const theme = "{{ user_prefs.theme|default('light') if user_prefs else 'light' }}";
  const font = "{{ user_prefs.font_family|default('Poppins') if user_prefs else 'Poppins' }}";
  const size = "{{ user_prefs.font_size|default('16px') if user_prefs else '16px' }}";
  const bold = {% if user_prefs and user_prefs.is_bold %}true{% else %}false{% endif %};

  if (theme) wrapper.classList.add("theme-" + theme);
  if (font) wrapper.style.setProperty("--font-family", font);
  if (size) wrapper.style.setProperty("--font-size", size);
  if (bold) wrapper.classList.add("font-bold");

  // Theme click + save
  document.querySelectorAll(".theme").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".theme").forEach(x => x.classList.remove("selected"));
      t.classList.add("selected");
      wrapper.classList.remove("theme-light", "theme-dark", "theme-aqua", "theme-green");
      wrapper.classList.add("theme-" + t.dataset.theme);
      saveAppearance();
    });
  });

  // Font controls
  document.getElementById("fontFamily")?.addEventListener("change", e => {
    wrapper.style.setProperty("--font-family", e.target.value);
    saveAppearance();
  });

  document.getElementById("fontSize")?.addEventListener("change", e => {
    wrapper.style.setProperty("--font-size", e.target.value);
    saveAppearance();
  });

  document.getElementById("boldToggle")?.addEventListener("change", e => {
    wrapper.classList.toggle("font-bold", e.target.checked);
    saveAppearance();
  });
}

async function saveAppearance() {
  const wrapper = document.querySelector(".main-wrapper");
  if (!wrapper) return;

  const theme = [...wrapper.classList].find(c => c.startsWith("theme-"))?.replace("theme-", "") || "light";
  const fontFamily = document.getElementById("fontFamily")?.value || "Poppins";
  const fontSize = document.getElementById("fontSize")?.value || "16px";
  const isBold = document.getElementById("boldToggle")?.checked || false;

  await fetch("/api/admin/save-appearance", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ theme, font_family: fontFamily, font_size: fontSize, is_bold: isBold })
  });
}

function saveAdminProfile(e) {
  e.preventDefault();
  // Admin general info is read-only, so no save needed
}

function changePassword(e) {
  e.preventDefault();

  const current = document.getElementById("current_password").value;
  const newPass = document.getElementById("new_password").value;
  const confirm = document.getElementById("confirm_password").value;

  if (newPass !== confirm) {
    alert("Passwords do not match");
    return;
  }

  fetch("/api/change_password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      current_password: current,
      new_password: newPass
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
    } else {
      alert(data.message || "Password updated successfully");
      document.getElementById("current_password").value = "";
      document.getElementById("new_password").value = "";
      document.getElementById("confirm_password").value = "";
    }
  })
  .catch(() => alert("Error updating password"));
}

function togglePassword(inputId, element) {
  const input = document.getElementById(inputId);
  if (input.type === "password") {
    input.type = "text";
    element.textContent = "Hide";
  } else {
    input.type = "password";
    element.textContent = "Show";
  }
}
</script> -->

<script src="{{ url_for('static', filename='script/admin_profile.js') }}"></script>
{% endblock %}
